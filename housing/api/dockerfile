# ===== 1. Base image =====
FROM python:3.10-slim AS base

# Set environment variables for Python
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PATH="/root/.local/bin:$PATH"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ===== 2. Install dependencies first for caching =====
WORKDIR /app

# Copy requirements and install
COPY requirements.txt .
RUN pip install --upgrade pip && \
    pip install --no-cache-dir \
    -i https://pypi.org/simple \
    --extra-index-url https://mirrors.aliyun.com/pypi/simple \
    -r requirements.txt

# ===== 3. Copy application code =====
COPY . .

# ===== 4. Expose API port =====
EXPOSE 5001

# ===== 5. Run API =====
CMD ["python", "-m", "housing.api.main"]